name: Laravel Pint

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  pint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('

- */composer.lock')

}}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Laravel Pint
        id: pint
        run: |
          ./vendor/bin/pint --test 2>&1 | tee pint-output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error:

**true**

- name: Check for style issues
        if: steps.pint.outputs.exit_code != '0'
        run: |
          echo "‚ùå Code style issues found!"
          cat pint-output.txt
          exit 1

      - name: Comment on PR with style issues
        if: failure()

**&&**

github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('pint-output.txt', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üé® Code Style Issues Detected\n\nLaravel Pint found formatting issues. Please run locally and commit fixes:\n\n\`\`\`bash\n./vendor/bin/pint\ngit add .\ngit commit -m "style: fix code formatting"\n\`\`\`\n\n<details>\n<summary>Details</summary>\n\n\`\`\`\n${output}\n\`\`\`\n\n</details>`
            });

  # Optional: Auto-fix and push changes
  pint-fix:
    runs-on: ubuntu-latest
    needs: pint
    if: failure()

**&&**

github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          tools: composer:v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run Laravel Pint (fix)
        run: ./vendor/bin/pint

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "style: fix code formatting with Laravel Pint"
            git push
          fi